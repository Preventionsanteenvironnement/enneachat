<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Admin ‚Äì Chat priv√©</title>

<style>
body{
  margin:0;
  font-family: system-ui, -apple-system, Segoe UI, Inter, sans-serif;
  background:#020617;
  color:#e5e7eb;
}
.app{
  display:flex;
  flex-direction:column;
  height:100vh;
}
.header{
  padding:10px 14px;
  border-bottom:1px solid #1f2937;
  background:linear-gradient(to right,#0f172a,#020617);
  display:flex;
  justify-content:space-between;
  align-items:center;
  gap:10px;
  flex-wrap:wrap;
}
.header h1{
  font-size:15px;
  margin:0;
}
.headerRight{
  display:flex;
  align-items:center;
  gap:8px;
  flex-wrap:wrap;
}
.status{
  background:#0f172a;
  border:1px solid #1f2937;
  padding:6px 10px;
  border-radius:999px;
  font-size:12px;
  display:flex;
  align-items:center;
  gap:6px;
}
.dot{
  width:8px;
  height:8px;
  border-radius:50%;
  background:#22c55e;
}
.refreshBtn{
  background:#1e293b;
  border:1px solid #334155;
  color:#e5e7eb;
  padding:6px 12px;
  border-radius:999px;
  cursor:pointer;
}
.refreshBtn:hover{
  background:#334155;
}

.container{
  flex:1;
  display:flex;
  min-height:0;
}
.sidebar{
  width:310px;
  border-right:1px solid #1f2937;
  display:flex;
  flex-direction:column;
  background:#030712;
}
.sidebar h2{
  font-size:13px;
  margin:10px 12px 6px;
  color:#94a3b8;
}
.list{
  flex:1;
  overflow-y:auto;
}
.item{
  padding:8px 10px;
  border-bottom:1px solid #0f172a;
  cursor:pointer;
}
.item:hover{
  background:#0b1220;
}
.item.active{
  background:#111827;
}
.item .title{
  font-size:13px;
  font-weight:500;
}
.item .meta{
  font-size:11px;
  color:#94a3b8;
}

.main{
  flex:1;
  display:flex;
  flex-direction:column;
}
.empty{
  flex:1;
  display:flex;
  align-items:center;
  justify-content:center;
  color:#64748b;
}

.topbar{
  padding:10px;
  border-bottom:1px solid #1f2937;
  display:flex;
  justify-content:space-between;
  align-items:center;
}

.btn-danger{
  background:#7f1d1d;
  border:1px solid #b91c1c;
  color:white;
  padding:8px 12px;
  border-radius:8px;
  cursor:pointer;
}
.btn-danger:hover{
  background:#b91c1c;
}

.messages{
  flex:1;
  overflow-y:auto;
  padding:10px;
  display:flex;
  flex-direction:column;
  gap:6px;
}

.msg{
  background:#020617;
  border:1px solid #1f2937;
  padding:8px 10px;
  border-radius:10px;
  max-width:70%;
}

.user{
  align-self:flex-end;
  background:#16a34a;
  color:#022c22;
}

.author{
  align-self:flex-start;
}

@media(max-width:900px){
  .sidebar{width:220px;}
}

@media(max-width:700px){
  .container{
    flex-direction:column;
  }
  .sidebar{
    width:100%;
    height:220px;
  }
}
</style>
</head>

<body>

<div class="app">

  <div class="header">
    <h1>Admin ‚Äì Chat priv√©</h1>

    <div class="headerRight">
      <button id="refreshBtn" class="refreshBtn">üîÑ Rafra√Æchir</button>

      <div class="status">
        <div class="dot"></div>
        <span>Connect√©</span>
      </div>
    </div>
  </div>

  <div class="container">
    <div class="sidebar">
      <h2>Conversations</h2>
      <div id="convList" class="list"></div>
    </div>

    <div class="main">
      <div class="topbar">
        <span id="convTitle">Aucune conversation</span>
        <button id="deleteBtn" class="btn-danger" disabled>
          Supprimer la conversation
        </button>
      </div>

      <div id="messages" class="messages">
        <div class="empty">S√©lectionne une conversation √† gauche.</div>
      </div>
    </div>
  </div>

</div>


<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import {
  getFirestore,
  collection,
  doc,
  deleteDoc,
  onSnapshot,
  query,
  orderBy
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey:"AIzaSyAd_3Qa9allKo9o4qZQQf3XVdRs3JMEGUQ",
  authDomain:"enneagramme-chat.firebaseapp.com",
  projectId:"enneagramme-chat"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const convList = document.getElementById("convList");
const messagesBox = document.getElementById("messages");
const convTitle = document.getElementById("convTitle");
const deleteBtn = document.getElementById("deleteBtn");
const refreshBtn = document.getElementById("refreshBtn");

let currentConvId = null;
let unsubMessages = null;

refreshBtn.onclick = ()=>location.reload();

function formatDate(ts){
  if(!ts) return "Conversation";
  const d = ts.toDate();
  return d.toLocaleDateString("fr-FR",{day:"2-digit",month:"short",year:"numeric"})+
         " ‚Äî "+
         d.toLocaleTimeString("fr-FR",{hour:"2-digit",minute:"2-digit"});
}

onSnapshot(collection(db,"conversations"), snapshot=>{
  convList.innerHTML="";

  const convs=snapshot.docs
    .map(d=>({id:d.id,...d.data()}))
    .sort((a,b)=>(b.lastUpdated?.seconds||0)-(a.lastUpdated?.seconds||0));

  if(convs.length===0){
    convList.innerHTML=`<div class="item"><div class="title">Aucune conversation</div></div>`;
    return;
  }

  convs.forEach(conv=>{
    const el=document.createElement("div");
    el.className="item"+(conv.id===currentConvId?" active":"");
    el.onclick=()=>openConversation(conv.id,conv.createdAt);

    el.innerHTML=`
      <div class="title">${formatDate(conv.createdAt)}</div>
      <div class="meta">${conv.lastMessage || ""}</div>
    `;

    convList.appendChild(el);
  });
});

function openConversation(id, createdAt){
  currentConvId=id;
  convTitle.textContent="Conversation ‚Äî "+formatDate(createdAt);
  deleteBtn.disabled=false;

  messagesBox.innerHTML="";

  if(unsubMessages) unsubMessages();

  const ref=collection(doc(db,"conversations",id),"messages");
  const q=query(ref, orderBy("createdAt","asc"));

  unsubMessages=onSnapshot(q,snap=>{
    messagesBox.innerHTML="";
    snap.forEach(m=>{
      const d=m.data();
      const div=document.createElement("div");
      div.className="msg "+(d.from==="user"?"user":"author");
      div.textContent=d.text || "";
      messagesBox.appendChild(div);
    });

    if(snap.empty){
      messagesBox.innerHTML=`<div class="empty">Aucun message encore.</div>`;
    }
  });
}

deleteBtn.onclick=async()=>{
  if(!currentConvId) return;
  if(!confirm("Supprimer d√©finitivement cette conversation ?")) return;

  await deleteDoc(doc(db,"conversations",currentConvId));

  currentConvId=null;
  convTitle.textContent="Aucune conversation";
  deleteBtn.disabled=true;
  messagesBox.innerHTML=`<div class="empty">Conversation supprim√©e.</div>`;
};
</script>

</body>
</html>
