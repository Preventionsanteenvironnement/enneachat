<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin ‚Äì Chat priv√© Enn√©agramme</title>
  <style>
    :root {
      --bg-main: #020617;
      --bg-panel: #020617;
      --bg-card: #020617;
      --bg-accent: #0f172a;
      --bg-bubble-user: #1f2937;
      --bg-bubble-admin: #14532d;
      --text-main: #e5e7eb;
      --text-muted: #9ca3af;
      --border-subtle: #1f2937;
      --accent: #22c55e;
      --accent-soft: rgba(34, 197, 94, 0.15);
      --danger: #ef4444;
      --scrollbar: #4b5563;
      --scrollbar-track: #020617;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text", sans-serif;
      background: radial-gradient(circle at top, #020617 0%, #020617 35%, #020617 100%);
      color: var(--text-main);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: stretch;
      padding: 24px;
    }

    .appShell {
      display: flex;
      flex-direction: column;
      width: 100%;
      max-width: 1200px;
      border-radius: 24px;
      background: radial-gradient(circle at top left, #020617, #020617 40%, #020617 100%);
      border: 1px solid #020617;
      box-shadow:
        0 24px 80px rgba(15, 23, 42, 0.8),
        0 0 0 1px rgba(148, 163, 184, 0.03);
      overflow: hidden;
    }

    .appHeader {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px 20px;
      border-bottom: 1px solid var(--border-subtle);
      background: radial-gradient(circle at top left, #020617, #020617 55%, #020617 100%);
    }

    .appTitleBlock {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .avatar {
      width: 44px;
      height: 44px;
      border-radius: 999px;
      overflow: hidden;
      border: 2px solid rgba(148, 163, 184, 0.5);
      background: radial-gradient(circle at 30% 20%, #f97316, #dc2626, #1e293b);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      font-size: 18px;
      color: #f9fafb;
    }

    .avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }

    .appTitleText h1 {
      font-size: 18px;
      font-weight: 600;
      letter-spacing: 0.02em;
    }

    .appTitleText p {
      font-size: 12px;
      color: var(--text-muted);
    }

    .statusPill {
      padding: 4px 10px;
      font-size: 12px;
      border-radius: 999px;
      border: 1px solid rgba(34, 197, 94, 0.5);
      background: radial-gradient(circle at left, var(--accent-soft), transparent 55%);
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .statusDot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: var(--accent);
      box-shadow: 0 0 0 4px rgba(34, 197, 94, 0.25);
    }

    .statusPill span {
      color: var(--text-muted);
    }

    .appBody {
      display: grid;
      grid-template-columns: minmax(240px, 320px) minmax(0, 1fr);
      min-height: 520px;
      height: 70vh;
    }

    /* Conversation list */

    .sidebar {
      border-right: 1px solid var(--border-subtle);
      background: radial-gradient(circle at top left, #020617, #020617 45%, #020617 100%);
      display: flex;
      flex-direction: column;
    }

    .sidebarHeader {
      padding: 10px 16px 6px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .sidebarHeader h2 {
      font-size: 13px;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: var(--text-muted);
    }

    .sidebarHeader small {
      font-size: 11px;
      color: var(--text-muted);
    }

    .convList {
      flex: 1;
      overflow-y: auto;
      padding: 4px 8px 12px;
    }

    .convList::-webkit-scrollbar,
    .messagesPane::-webkit-scrollbar {
      width: 7px;
    }
    .convList::-webkit-scrollbar-track,
    .messagesPane::-webkit-scrollbar-track {
      background: var(--scrollbar-track);
    }
    .convList::-webkit-scrollbar-thumb,
    .messagesPane::-webkit-scrollbar-thumb {
      background: var(--scrollbar);
      border-radius: 999px;
    }

    .convItem {
      border-radius: 14px;
      padding: 10px 10px;
      display: flex;
      flex-direction: column;
      gap: 2px;
      margin-bottom: 4px;
      border: 1px solid transparent;
      cursor: pointer;
      transition: background 0.15s ease, border-color 0.15s ease, transform 0.05s ease;
      background: linear-gradient(120deg, rgba(15, 23, 42, 0.9), rgba(15, 23, 42, 0.95));
    }

    .convItem:hover {
      border-color: rgba(148, 163, 184, 0.4);
      transform: translateY(-1px);
    }

    .convItem.active {
      border-color: var(--accent);
      background: linear-gradient(120deg, rgba(22, 163, 74, 0.15), rgba(15, 23, 42, 0.95));
    }

    .convTopRow {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 8px;
    }

    .convTitle {
      font-size: 13px;
      font-weight: 500;
    }

    .convMeta {
      font-size: 11px;
      color: var(--text-muted);
      white-space: nowrap;
    }

    .convPreview {
      font-size: 12px;
      color: var(--text-muted);
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    .convTag {
      display: inline-flex;
      padding: 2px 7px;
      border-radius: 999px;
      background: rgba(55, 65, 81, 0.7);
      font-size: 11px;
      color: var(--text-muted);
      margin-right: 6px;
    }

    /* Messages area */

    .mainPanel {
      display: flex;
      flex-direction: column;
      background: radial-gradient(circle at top, #020617, #020617 45%, #020617 100%);
    }

    .mainHeader {
      padding: 10px 16px;
      border-bottom: 1px solid var(--border-subtle);
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 8px;
    }

    .mainHeaderTitle {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .mainHeaderTitle h2 {
      font-size: 15px;
      font-weight: 500;
    }

    .mainHeaderTitle span {
      font-size: 12px;
      color: var(--text-muted);
    }

    .mainHeaderMeta {
      font-size: 11px;
      color: var(--text-muted);
      text-align: right;
    }

    .messagesPane {
      flex: 1;
      overflow-y: auto;
      padding: 14px 18px 10px;
      position: relative;
    }

    .emptyState {
      position: absolute;
      inset: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 8px;
      color: var(--text-muted);
      font-size: 13px;
    }

    .emptyState span {
      font-size: 32px;
    }

    .msgGroup {
      max-width: 620px;
      margin-bottom: 10px;
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .msgGroup.user {
      align-items: flex-start;
    }

    .msgGroup.admin {
      align-items: flex-end;
      margin-left: auto;
    }

    .bubble {
      padding: 9px 12px;
      border-radius: 14px;
      font-size: 13px;
      line-height: 1.4;
      box-shadow: 0 4px 18px rgba(15, 23, 42, 0.7);
      border: 1px solid transparent;
      white-space: pre-wrap;
      word-wrap: break-word;
    }

    .msgGroup.user .bubble {
      background: var(--bg-bubble-user);
      border-color: rgba(75, 85, 99, 0.7);
    }

    .msgGroup.admin .bubble {
      background: var(--bg-bubble-admin);
      border-color: rgba(34, 197, 94, 0.8);
    }

    .msgMeta {
      font-size: 11px;
      color: var(--text-muted);
      margin-top: 2px;
    }

    .msgGroup.admin .msgMeta {
      text-align: right;
    }

    .composer {
      border-top: 1px solid var(--border-subtle);
      padding: 10px 14px;
      display: flex;
      flex-direction: column;
      gap: 6px;
      background: #020617;
    }

    .composerTop {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 11px;
      color: var(--text-muted);
    }

    .sessionId {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 11px;
      background: rgba(15, 23, 42, 0.9);
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid rgba(55, 65, 81, 0.9);
    }

    .composerMain {
      display: flex;
      gap: 8px;
      align-items: flex-end;
    }

    .composer textarea {
      flex: 1;
      resize: none;
      min-height: 40px;
      max-height: 96px;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid rgba(55, 65, 81, 0.9);
      background: rgba(15, 23, 42, 0.95);
      color: var(--text-main);
      font-size: 13px;
      outline: none;
    }

    .composer textarea::placeholder {
      color: #6b7280;
    }

    .btnSend {
      padding: 10px 16px;
      border-radius: 999px;
      border: none;
      font-size: 13px;
      font-weight: 500;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      cursor: pointer;
      background: radial-gradient(circle at top left, #22c55e, #16a34a);
      color: #022c22;
      box-shadow:
        0 12px 30px rgba(22, 163, 74, 0.55),
        0 0 0 1px rgba(22, 163, 74, 0.2);
      transition: transform 0.05s ease, box-shadow 0.1s ease, filter 0.1s ease;
    }

    .btnSend:disabled {
      opacity: 0.4;
      cursor: default;
      box-shadow: none;
    }

    .btnSend:not(:disabled):hover {
      filter: brightness(1.05);
      transform: translateY(-1px);
    }

    .btnSend:not(:disabled):active {
      transform: translateY(0);
      box-shadow:
        0 6px 18px rgba(22, 163, 74, 0.45),
        0 0 0 1px rgba(22, 163, 74, 0.25);
    }

    .btnSend span.icon {
      font-size: 14px;
    }

    .infoBar {
      font-size: 11px;
      color: var(--text-muted);
      text-align: right;
    }

    .infoBar strong {
      color: #e5e7eb;
    }

    .errorBanner {
      position: absolute;
      top: 10px;
      right: 14px;
      padding: 6px 10px;
      border-radius: 999px;
      background: rgba(127, 29, 29, 0.95);
      color: #fee2e2;
      font-size: 11px;
      display: none;
      align-items: center;
      gap: 8px;
      z-index: 20;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.7);
    }

    .errorBanner span.icon {
      font-size: 13px;
    }

    @media (max-width: 900px) {
      body {
        padding: 12px;
      }
      .appBody {
        grid-template-columns: minmax(0, 1fr);
      }
      .sidebar {
        max-height: 220px;
      }
      .mainPanel {
        border-top: 1px solid var(--border-subtle);
      }
    }
  </style>
</head>

<body>
  <div class="appShell">
    <header class="appHeader">
      <div class="appTitleBlock">
        <div class="avatar">
          <!-- Option 1 : texte -->
          <!-- <span>BB</span> -->
          <!-- Option 2 : ton image si tu veux -->
          <!-- <img src="assets/img/avatar-chat.png" alt="Avatar admin" /> -->
          <span>BB</span>
        </div>
        <div class="appTitleText">
          <h1>Admin ‚Äì Chat priv√©</h1>
          <p>R√©ponses aux questions sur l‚ÄôEnn√©agramme</p>
        </div>
      </div>
      <div class="statusPill">
        <div class="statusDot"></div>
        <span>Connect√© √† Firestore</span>
      </div>
    </header>

    <div class="appBody">
      <!-- Colonne conversations -->
      <aside class="sidebar">
        <div class="sidebarHeader">
          <div>
            <h2>Conversations</h2>
            <small id="convCount">Aucune conversation</small>
          </div>
        </div>
        <div class="convList" id="conversationList">
          <!-- Conversations charg√©es depuis Firestore -->
        </div>
      </aside>

      <!-- Colonne messages -->
      <section class="mainPanel">
        <div class="errorBanner" id="errorBanner">
          <span class="icon">‚ö†Ô∏è</span>
          <span id="errorText">Erreur</span>
        </div>

        <div class="mainHeader">
          <div class="mainHeaderTitle">
            <h2 id="currentConvTitle">S√©lectionne une conversation</h2>
            <span id="currentConvSub">Les messages appara√Ætront ici.</span>
          </div>
          <div class="mainHeaderMeta" id="currentConvMeta">
            ‚Äî
          </div>
        </div>

        <div class="messagesPane" id="messagesPane">
          <div class="emptyState" id="emptyState">
            <span>üí¨</span>
            <div>Aucune conversation s√©lectionn√©e.</div>
            <div style="font-size:12px;">Clique √† gauche pour ouvrir un fil.</div>
          </div>
          <div id="messages"></div>
        </div>

        <div class="composer">
          <div class="composerTop">
            <div class="infoBar">
              Conversation <strong>priv√©e</strong> reli√©e √† l‚Äôappareil de la personne.
            </div>
            <div class="sessionId" id="sessionIdBadge">Session : ‚Äî</div>
          </div>
          <div class="composerMain">
            <textarea id="replyInput" placeholder="√âcris ta r√©ponse ici‚Ä¶ (Entr√©e pour envoyer, Shift+Entr√©e pour une nouvelle ligne)" disabled></textarea>
            <button class="btnSend" id="btnSend" disabled>
              <span class="icon">‚û§</span>
              <span>Envoyer</span>
            </button>
          </div>
        </div>
      </section>
    </div>
  </div>

  <!-- Firebase -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import {
      getFirestore,
      collection,
      addDoc,
      serverTimestamp,
      query,
      orderBy,
      onSnapshot,
      doc,
      updateDoc
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import {
      getAuth,
      signInAnonymously
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    // === Config Firestore ‚Äì m√™me projet que le chat public ===
    const firebaseConfig = {
      apiKey: "AIzaSyAd_3Qa9allKo9o4qZQQf3XVdRs3JMEGUQ",
      authDomain: "enneagramme-chat.firebaseapp.com",
      projectId: "enneagramme-chat",
      storageBucket: "enneagramme-chat.firebasestorage.app",
      messagingSenderId: "703457736548",
      appId: "1:703457736548:web:f91f0a1f36fd1a441e6c71",
      measurementId: "G-6WB7Y3E5CK"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    // === R√©f√©rences DOM ===
    const convListEl = document.getElementById("conversationList");
    const convCountEl = document.getElementById("convCount");
    const messagesPaneEl = document.getElementById("messagesPane");
    const messagesEl = document.getElementById("messages");
    const emptyStateEl = document.getElementById("emptyState");
    const headerTitleEl = document.getElementById("currentConvTitle");
    const headerSubEl = document.getElementById("currentConvSub");
    const headerMetaEl = document.getElementById("currentConvMeta");
    const sessionIdBadgeEl = document.getElementById("sessionIdBadge");
    const replyInputEl = document.getElementById("replyInput");
    const btnSendEl = document.getElementById("btnSend");
    const errorBannerEl = document.getElementById("errorBanner");
    const errorTextEl = document.getElementById("errorText");

    let currentConvId = null;
    let currentConvData = null;
    let unsubscribeMessages = null;

    function showError(msg) {
      errorTextEl.textContent = msg;
      errorBannerEl.style.display = "flex";
      setTimeout(() => {
        errorBannerEl.style.display = "none";
      }, 4500);
    }

    function formatDate(ts) {
      if (!ts) return "";
      try {
        const d = ts.toDate ? ts.toDate() : new Date(ts);
        return d.toLocaleString("fr-FR", {
          day: "2-digit",
          month: "2-digit",
          hour: "2-digit",
          minute: "2-digit"
        });
      } catch {
        return "";
      }
    }

    function limitPreview(text, max = 60) {
      if (!text) return "";
      if (text.length <= max) return text;
      return text.slice(0, max - 1) + "‚Ä¶";
    }

    function selectConversation(convId, data) {
      currentConvId = convId;
      currentConvData = data || null;

      // Mise √† jour header
      headerTitleEl.textContent = `Session ${convId}`;
      headerSubEl.textContent = data && data.lastMessage
        ? `Dernier message : ${limitPreview(data.lastMessage, 80)}`
        : "Aucun message pour l‚Äôinstant.";
      headerMetaEl.textContent = data && data.createdAt
        ? `Cr√©√©e le ${formatDate(data.createdAt)}`
        : "Date inconnue";

      sessionIdBadgeEl.textContent = `Session : ${convId}`;

      // Active sur la liste
      Array.from(convListEl.querySelectorAll(".convItem")).forEach(item => {
        item.classList.toggle("active", item.dataset.id === convId);
      });

      // Autoriser la saisie
      replyInputEl.disabled = false;
      btnSendEl.disabled = false;
      replyInputEl.focus();

      subscribeToMessages(convId);
    }

    function renderConversations(snapshot) {
      convListEl.innerHTML = "";
      let count = 0;

      snapshot.forEach(docSnap => {
        count++;
        const data = docSnap.data() || {};
        const id = docSnap.id;

        const item = document.createElement("button");
        item.type = "button";
        item.className = "convItem";
        item.dataset.id = id;

        const title = document.createElement("div");
        title.className = "convTopRow";

        const left = document.createElement("div");
        const right = document.createElement("div");

        left.innerHTML = `
          <div class="convTitle">Session ${id}</div>
        `;

        const dateStr = data.createdAt ? formatDate(data.createdAt) : "Date inconnue";
        right.className = "convMeta";
        right.textContent = dateStr;

        title.appendChild(left);
        title.appendChild(right);

        const preview = document.createElement("div");
        preview.className = "convPreview";
        const last = data.lastMessage || "";
        preview.textContent = last ? last : "Aucun message.";

        item.appendChild(title);

        if (last) {
          item.appendChild(preview);
        }

        item.addEventListener("click", () => {
          selectConversation(id, data);
        });

        convListEl.appendChild(item);
      });

      convCountEl.textContent = count === 0
        ? "Aucune conversation"
        : `${count} conversation${count > 1 ? "s" : ""}`;
    }

    function subscribeToMessages(convId) {
      if (unsubscribeMessages) {
        unsubscribeMessages();
        unsubscribeMessages = null;
      }

      const msgRef = collection(db, "conversations", convId, "messages");
      const q = query(msgRef, orderBy("createdAt", "asc"));

      unsubscribeMessages = onSnapshot(q, snapshot => {
        messagesEl.innerHTML = "";
        let hasMessages = false;

        snapshot.forEach(docSnap => {
          hasMessages = true;
          const data = docSnap.data() || {};
          const from = data.from || "user";
          const text = data.text || "";
          const createdAt = data.createdAt;

          const group = document.createElement("div");
          group.className = "msgGroup " + (from === "admin" ? "admin" : "user");

          const bubble = document.createElement("div");
          bubble.className = "bubble";
          bubble.textContent = text;

          const meta = document.createElement("div");
          meta.className = "msgMeta";
          const label = from === "admin" ? "Toi" : "Visiteur";
          meta.textContent = `${label} ‚Ä¢ ${formatDate(createdAt)}`;

          group.appendChild(bubble);
          group.appendChild(meta);

          messagesEl.appendChild(group);
        });

        emptyStateEl.style.display = hasMessages ? "none" : "flex";
        // Scroller en bas
        messagesPaneEl.scrollTop = messagesPaneEl.scrollHeight;
      }, err => {
        showError("Erreur de lecture des messages.");
        console.error(err);
      });
    }

    async function sendMessage() {
      const text = replyInputEl.value.trim();
      if (!text || !currentConvId) return;

      try {
        btnSendEl.disabled = true;

        const msgRef = collection(db, "conversations", currentConvId, "messages");
        await addDoc(msgRef, {
          text,
          from: "admin",
          createdAt: serverTimestamp()
        });

        const convRef = doc(db, "conversations", currentConvId);
        await updateDoc(convRef, {
          lastMessage: text,
          lastMessageAt: serverTimestamp()
        });

        replyInputEl.value = "";
        replyInputEl.focus();
      } catch (err) {
        console.error(err);
        showError("Impossible d‚Äôenvoyer le message.");
      } finally {
        btnSendEl.disabled = false;
      }
    }

    btnSendEl.addEventListener("click", sendMessage);
    replyInputEl.addEventListener("keydown", (e) => {
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    });

    // Connexion anonyme & abonnement aux conversations
    signInAnonymously(auth)
      .then(() => {
        const convRef = collection(db, "conversations");
        const q = query(convRef, orderBy("createdAt", "desc"));
        onSnapshot(q, renderConversations, (err) => {
          console.error(err);
          showError("Erreur de lecture des conversations.");
        });
      })
      .catch(err => {
        console.error(err);
        showError("Impossible de se connecter √† Firestore.");
      });
  </script>
</body>
</html>